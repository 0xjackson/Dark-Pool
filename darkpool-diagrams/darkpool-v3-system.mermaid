%%{init: {'theme': 'dark', 'themeVariables': { 'primaryColor': '#1a1a2e', 'primaryTextColor': '#ffffff', 'primaryBorderColor': '#F59E0B', 'lineColor': '#6B7280'}}}%%

flowchart TB
    subgraph Title[" "]
        T1["ğŸŒ‘ DARK POOL PROTOCOL"]
        T2["Trustless P2P Large-Block Trading"]
    end

    subgraph Users["ğŸ‘¥ USERS"]
        W1["ğŸ‹ Whales"]
        W2["ğŸ¦ Institutions"]
        W3["ğŸ¤– Market Makers"]
    end

    subgraph Client["ğŸ–¥ï¸ CLIENT LAYER"]
        direction TB
        CW["ğŸ¦Š Wallet Connect<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>MetaMask / WalletConnect<br/>Sign transactions"]
        CU["ğŸ¨ Trading UI<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Order form<br/>Set slippage tolerance<br/>View order status"]
        CN["ğŸ”” Notifications<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Match alerts<br/>Settlement confirmations"]
    end

    subgraph Server["âš™ï¸ SERVER LAYER"]
        direction TB
        SA["ğŸŒ API Gateway<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>REST + WebSocket<br/>Order submission<br/>Status polling"]
        SY["ğŸŸ¡ Yellow SDK<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Clearnode connection<br/>State channel mgmt<br/>Signature relay"]
        SO["ğŸ“Š Order Manager<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Track active orders<br/>Match notifications<br/>Settlement coordination"]
        SD[("ğŸ’¾ Database<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Order history<br/>User preferences")]
    end

    subgraph Constraints["ğŸ“œ CONSTRAINT CONTRACT"]
        direction TB
        CL["ğŸ”’ Lock Assets<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>User's tokens locked<br/>until settled/cancelled"]
        CO["ğŸ“Š Oracle Query<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Pyth: ETH = $2,000"]
        CC["ğŸ§® Calculate Min<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>500 Ã— $2,000 Ã— 0.99<br/>= $990,000 USDC min"]
        CS["ğŸ’¾ Store On-Chain<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>minBuyAmount<br/>expiry, slippage"]
        
        CL --> CO --> CC --> CS
    end

    subgraph Yellow["ğŸŸ¡ YELLOW NETWORK"]
        direction TB
        YE["ğŸ” Encrypted Orders<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Price + size hidden"]
        YO["ğŸ“’ Dark Orderbook<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Off-chain matching"]
        YM["âš¡ P2P Matching<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Find counterparty"]
        YS["âœï¸ Signatures<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Both parties sign"]
        
        YE --> YO --> YM --> YS
    end

    subgraph Hook["ğŸ¦„ UNISWAP V4 HOOK"]
        direction TB
        HV["ğŸ” Verify Sigs<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Both parties signed?"]
        HC["ğŸ“ Call Constraints<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>verifyAndSettle()"]
        HD{"ğŸ›¡ï¸ Check<br/>$995k â‰¥ $990k?"}
        HE["âš›ï¸ Atomic Settle<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>P2P via PoolManager"]
        HX["âŒ REVERT<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>User protected"]
        
        HV --> HC --> HD
        HD -->|"âœ… Yes"| HE
        HD -->|"âŒ No"| HX
    end

    subgraph Settlement["âœ… ATOMIC SETTLEMENT"]
        direction LR
        S1["500 ETH<br/>Seller â†’ Buyer"]
        S2["$995,000 USDC<br/>Buyer â†’ Seller"]
    end

    Users --> Client
    Client --> Server
    Server --> Constraints
    Server <--> Yellow
    Constraints --> Yellow
    Yellow --> Hook
    HE --> Settlement

    style Client fill:#6366F1,stroke:#4338CA,color:#fff
    style Server fill:#8B5CF6,stroke:#6D28D9,color:#fff
    style Constraints fill:#10B981,stroke:#047857,color:#fff
    style Yellow fill:#F59E0B,stroke:#B45309,color:#000
    style Hook fill:#FF007A,stroke:#99004d,color:#fff
    style Settlement fill:#3B82F6,stroke:#1E40AF,color:#fff
