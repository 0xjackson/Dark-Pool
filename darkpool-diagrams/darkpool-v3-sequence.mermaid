sequenceDiagram
    autonumber
    
    participant User as ğŸ‘¤ Seller
    participant Client as ğŸ–¥ï¸ Client<br/>(React dApp)
    participant Server as âš™ï¸ Server<br/>(API + Yellow SDK)
    participant Constraint as ğŸ“œ Constraint<br/>Contract
    participant Pyth as ğŸ”® Pyth<br/>Oracle
    participant Yellow as ğŸŸ¡ Yellow<br/>Clearnode
    participant Buyer as ğŸ‘¤ Buyer
    participant Hook as ğŸ¦„ v4 Hook
    participant PM as ğŸ± Pool<br/>Manager

    rect rgb(99, 102, 241, 0.15)
        Note over User,PM: ğŸ–¥ï¸ PHASE 0: CLIENT INTERACTION
        
        User->>Client: Connect wallet (MetaMask)
        Client->>Client: Load trading UI
        User->>Client: "Sell 500 ETH, max 1% slippage"
        Client->>Client: Validate inputs
        Client->>Server: POST /orders (sellToken, amount, slippage)
    end

    rect rgb(139, 92, 246, 0.15)
        Note over User,PM: âš™ï¸ PHASE 1: SERVER PROCESSING
        
        Server->>Server: Generate order params
        Server->>Pyth: Fetch fresh price update
        Pyth-->>Server: priceUpdateData
        Server->>Constraint: createOrder(ETH, USDC, 500, 100bps, expiry, priceUpdate)
    end

    rect rgb(16, 185, 129, 0.15)
        Note over User,PM: ğŸ“œ PHASE 2: CONSTRAINT LOCKING
        
        Constraint->>Constraint: Lock 500 ETH from user
        Constraint->>Pyth: getPrice(ETH/USD)
        Pyth-->>Constraint: $2,000.00
        
        Constraint->>Constraint: Calculate minOutput<br/>500 Ã— $2,000 Ã— 0.99 = $990,000
        Constraint->>Constraint: Store order constraints
        
        Constraint-->>Server: orderId + constraints
        Server-->>Client: { orderId, status: "active", minOutput: 990000 }
        Client-->>User: "Order created! Waiting for match..."
    end

    rect rgb(245, 158, 11, 0.15)
        Note over User,PM: ğŸŸ¡ PHASE 3: PRIVATE MATCHING
        
        Server->>Yellow: Submit encrypted order
        Yellow->>Yellow: Add to dark orderbook
        
        Note over Yellow: Buyer submits order via their client/server
        Buyer->>Yellow: Encrypted buy order (995k USDC)
        
        Yellow->>Yellow: Match found!<br/>Seller: 500 ETH @ $990k min<br/>Buyer: $995k USDC
        
        Yellow-->>Server: Match notification
        Server-->>Client: WebSocket: "Match found!"
        Client-->>User: "Match found! Sign to confirm"
        
        User->>Client: Confirm settlement
        Client->>Server: Sign settlement message
        Server->>Yellow: Submit seller signature
        
        Note over Yellow: Buyer also signs
        Yellow->>Yellow: Both signatures collected
    end

    rect rgb(255, 0, 122, 0.15)
        Note over User,PM: ğŸ›¡ï¸ PHASE 4: CONSTRAINT VERIFICATION
        
        Yellow->>Hook: settleP2P(orderId, buyerOrderId, sigs, amounts)
        
        Hook->>Hook: Verify both signatures âœ“
        
        Hook->>Constraint: verifyAndSettle(orderId, buyer, $995,000)
        
        Constraint->>Constraint: Check: active? âœ“
        Constraint->>Constraint: Check: not expired? âœ“
        Constraint->>Constraint: Check: $995k â‰¥ $990k? âœ“
        
        Constraint-->>Hook: TRUE âœ…
    end

    rect rgb(59, 130, 246, 0.15)
        Note over User,PM: âš›ï¸ PHASE 5: ATOMIC SETTLEMENT
        
        Hook->>Constraint: getLockedTokens(orderId)
        Constraint-->>Hook: (ETH, 500, seller)
        
        Hook->>PM: take(ETH, 500) from Constraint
        Hook->>PM: settle(ETH, 500) to Buyer
        
        Hook->>PM: take(USDC, 995k) from Buyer
        Hook->>PM: settle(USDC, 995k) to Seller
        
        PM-->>Buyer: Receives 500 ETH âœ…
        PM-->>User: Receives $995,000 USDC âœ…
        
        Hook-->>Server: Settlement complete event
        Server-->>Client: WebSocket: "Settlement complete!"
        Client-->>User: "ğŸ‰ Trade complete! +$995,000 USDC"
    end
